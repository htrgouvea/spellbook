package Spellbook::Exploit::WPScan_0218c90c {
    use strict;
    use warnings;
    use Mojo::Parameters;
    use Mojo::URL;
    use Mojo::UserAgent;

    our $VERSION = '0.0.1';

    sub new {
        my ($self, $parameters) = @_;
        my (
            $help,
            $target,
            $path,
            $parameter,
            $payload,
            $indicator,
            $method,
            @result
        );

        Getopt::Long::GetOptionsFromArray(
            $parameters,
            'h|help'         => \$help,
            't|target=s'     => \$target,
            'p|path=s'       => \$path,
            'k|parameter=s'  => \$parameter,
            'v|payload=s'    => \$payload,
            'i|indicator=s'  => \$indicator,
            'm|method=s'     => \$method
        );

        if ($target) {
            if ($target !~ /^http(s)?:\/\//x) {
                $target = "http://$target";
            }

            if (!$path) {
                $path = "/";
            }

            if (!$parameter) {
                $parameter = "input";
            }

            if (!$payload) {
                $payload = "spellbook-test";
            }

            if (!$indicator) {
                $indicator = $payload;
            }

            if (!$method) {
                $method = "GET";
            }

            my $userAgent = Mojo::UserAgent -> new();
            my $requestUrl = Mojo::URL -> new($target);

            if ($path !~ m{^/}x) {
                $path = "/$path";
            }

            $requestUrl -> path($path);

            my $response;
            my $methodValue = uc $method;

            if ($methodValue eq "POST") {
                my %formPayload = ($parameter => $payload);
                $response = $userAgent -> post(
                    $requestUrl,
                    form => \%formPayload
                ) -> result();
            }

            if ($methodValue ne "POST") {
                my $query = Mojo::Parameters -> new();
                $query -> append($parameter, $payload);
                $requestUrl -> query($query);
                $response = $userAgent -> get($requestUrl) -> result();
            }

            if ($response) {
                if ($response -> is_success()) {
                    my $content = $response -> body();

                    if ($content =~ /\Q$indicator\E/x) {
                        push @result, $requestUrl;
                    }
                }
            }

            return @result;
        }

        if ($help) {
            return "
                \rExploit::WPScan_0218c90c
                \r========================
                \r-h, --help          See this menu
                \r-t, --target        Set a target host
                \r-p, --path          Set the vulnerable endpoint path
                \r-k, --parameter     Set the vulnerable parameter name
                \r-v, --payload       Set the payload to send
                \r-i, --indicator     Set the response indicator
                \r-m, --method        Set HTTP method (GET or POST)\n\n";
        }

        return 0;
    }
}

1;
